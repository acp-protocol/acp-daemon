name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          # Linux glibc
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          # Linux musl (static)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          # Windows not supported - daemonize crate is Unix-only
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Clone acp-cli dependency
        run: git clone --depth 1 --recurse-submodules https://github.com/acp-protocol/acp-cli.git ../acp-cli

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create archive (Unix)
        if: matrix.archive == 'tar.gz'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/acpd dist/
          cd dist
          tar -czvf ../acpd-${{ matrix.target }}.tar.gz acpd
          cd ..
          shasum -a 256 acpd-${{ matrix.target }}.tar.gz > acpd-${{ matrix.target }}.tar.gz.sha256

      - name: Create archive (Windows)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          mkdir dist
          cp target/${{ matrix.target }}/release/acpd.exe dist/
          Compress-Archive -Path dist/acpd.exe -DestinationPath acpd-${{ matrix.target }}.zip
          $hash = (Get-FileHash acpd-${{ matrix.target }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  acpd-${{ matrix.target }}.zip" | Out-File -Encoding ASCII acpd-${{ matrix.target }}.zip.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: acpd-${{ matrix.target }}
          path: |
            acpd-${{ matrix.target }}.*
          if-no-files-found: error

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}

  publish-crates:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --no-verify --allow-dirty

  publish-npm:
    name: Publish to npm
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare npm packages
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Windows not supported - daemonize crate is Unix-only
          declare -A PLATFORMS=(
            ["aarch64-apple-darwin"]="darwin-arm64"
            ["x86_64-apple-darwin"]="darwin-x64"
            ["x86_64-unknown-linux-gnu"]="linux-x64-gnu"
            ["x86_64-unknown-linux-musl"]="linux-x64-musl"
            ["aarch64-unknown-linux-gnu"]="linux-arm64-gnu"
            ["aarch64-unknown-linux-musl"]="linux-arm64-musl"
          )

          for target in "${!PLATFORMS[@]}"; do
            npm_platform="${PLATFORMS[$target]}"
            pkg_dir="npm-packages/@acp-protocol/daemon-${npm_platform}"
            mkdir -p "$pkg_dir/bin"

            if [[ "$target" == *"windows"* ]]; then
              unzip -o "artifacts/acpd-${target}/acpd-${target}.zip" -d "$pkg_dir/bin/"
              binary_name="acpd.exe"
            else
              tar -xzf "artifacts/acpd-${target}/acpd-${target}.tar.gz" -C "$pkg_dir/bin/"
              binary_name="acpd"
              chmod +x "$pkg_dir/bin/$binary_name"
            fi

            cat > "$pkg_dir/package.json" << EOF
          {
            "name": "@acp-protocol/daemon-${npm_platform}",
            "version": "${VERSION}",
            "description": "ACP Daemon binary for ${npm_platform}",
            "os": ["$(echo $npm_platform | cut -d'-' -f1 | sed 's/win32/win32/')"],
            "cpu": ["$(echo $npm_platform | cut -d'-' -f2 | sed 's/x64/x64/;s/arm64/arm64/')"],
            "main": "bin/${binary_name}",
            "repository": {
              "type": "git",
              "url": "git+https://github.com/acp-protocol/acp-daemon.git"
            },
            "license": "MIT"
          }
          EOF
          done

          main_dir="npm-packages/@acp-protocol/daemon"
          mkdir -p "$main_dir/bin"

          cat > "$main_dir/package.json" << 'PKGJSON'
          {
            "name": "@acp-protocol/daemon",
            "version": "VERSION_PLACEHOLDER",
            "description": "ACP Daemon - HTTP REST API for codebase intelligence",
            "bin": {
              "acpd": "bin/acpd.js"
            },
            "repository": {
              "type": "git",
              "url": "git+https://github.com/acp-protocol/acp-daemon.git"
            },
            "keywords": ["ai", "daemon", "rest-api", "code-analysis", "llm", "context"],
            "license": "MIT",
            "optionalDependencies": {
              "@acp-protocol/daemon-darwin-arm64": "VERSION_PLACEHOLDER",
              "@acp-protocol/daemon-darwin-x64": "VERSION_PLACEHOLDER",
              "@acp-protocol/daemon-linux-x64-gnu": "VERSION_PLACEHOLDER",
              "@acp-protocol/daemon-linux-x64-musl": "VERSION_PLACEHOLDER",
              "@acp-protocol/daemon-linux-arm64-gnu": "VERSION_PLACEHOLDER",
              "@acp-protocol/daemon-linux-arm64-musl": "VERSION_PLACEHOLDER"
            }
          }
          PKGJSON

          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" "$main_dir/package.json"

          cat > "$main_dir/bin/acpd.js" << 'WRAPPER'
          #!/usr/bin/env node
          const { execFileSync } = require('child_process');
          const path = require('path');

          const PLATFORMS = {
            'darwin-arm64': '@acp-protocol/daemon-darwin-arm64',
            'darwin-x64': '@acp-protocol/daemon-darwin-x64',
            'linux-x64': '@acp-protocol/daemon-linux-x64-gnu',
            'linux-arm64': '@acp-protocol/daemon-linux-arm64-gnu',
          };

          const MUSL_FALLBACKS = {
            'linux-x64': '@acp-protocol/daemon-linux-x64-musl',
            'linux-arm64': '@acp-protocol/daemon-linux-arm64-musl',
          };

          const platformKey = `${process.platform}-${process.arch}`;
          let pkg = PLATFORMS[platformKey];

          if (!pkg) {
            console.error(`Unsupported platform: ${platformKey}`);
            process.exit(1);
          }

          function tryResolve(packageName) {
            try {
              const pkgPath = require.resolve(`${packageName}/package.json`);
              const pkgDir = path.dirname(pkgPath);
              const binName = process.platform === 'win32' ? 'acpd.exe' : 'acpd';
              return path.join(pkgDir, 'bin', binName);
            } catch {
              return null;
            }
          }

          let binaryPath = tryResolve(pkg);

          if (!binaryPath && MUSL_FALLBACKS[platformKey]) {
            binaryPath = tryResolve(MUSL_FALLBACKS[platformKey]);
          }

          if (!binaryPath) {
            console.error(`Could not find ACP Daemon binary for ${platformKey}`);
            console.error('Try reinstalling: npm install -g @acp-protocol/daemon');
            process.exit(1);
          }

          try {
            execFileSync(binaryPath, process.argv.slice(2), { stdio: 'inherit' });
          } catch (error) {
            if (error.status !== undefined) {
              process.exit(error.status);
            }
            throw error;
          }
          WRAPPER

          chmod +x "$main_dir/bin/acpd.js"

      - name: Publish platform packages to npm
        run: |
          for pkg_dir in npm-packages/@acp-protocol/daemon-*; do
            if [ -d "$pkg_dir" ]; then
              echo "Publishing $(basename $pkg_dir)..."
              cd "$pkg_dir"
              npm publish --access public --provenance || echo "Failed to publish $(basename $pkg_dir), may already exist"
              cd -
            fi
          done

      - name: Publish main package to npm
        run: |
          cd npm-packages/@acp-protocol/daemon
          npm publish --access public --provenance

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download artifacts for SHA256
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Homebrew formula
        run: |
          VERSION=${{ steps.version.outputs.version }}

          SHA_DARWIN_ARM64=$(cat artifacts/acpd-aarch64-apple-darwin/acpd-aarch64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
          SHA_DARWIN_X64=$(cat artifacts/acpd-x86_64-apple-darwin/acpd-x86_64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
          SHA_LINUX_ARM64=$(cat artifacts/acpd-aarch64-unknown-linux-gnu/acpd-aarch64-unknown-linux-gnu.tar.gz.sha256 | awk '{print $1}')
          SHA_LINUX_X64=$(cat artifacts/acpd-x86_64-unknown-linux-gnu/acpd-x86_64-unknown-linux-gnu.tar.gz.sha256 | awk '{print $1}')

          cat > acpd.rb << EOF
          class Acpd < Formula
            desc "ACP Daemon - HTTP REST API for codebase intelligence"
            homepage "https://github.com/acp-protocol/acp-daemon"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/acp-protocol/acp-daemon/releases/download/v${VERSION}/acpd-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_DARWIN_ARM64}"
              end
              on_intel do
                url "https://github.com/acp-protocol/acp-daemon/releases/download/v${VERSION}/acpd-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_DARWIN_X64}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/acp-protocol/acp-daemon/releases/download/v${VERSION}/acpd-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              end
              on_intel do
                url "https://github.com/acp-protocol/acp-daemon/releases/download/v${VERSION}/acpd-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_X64}"
              end
            end

            def install
              bin.install "acpd"
            end

            test do
              assert_match "acpd", shell_output("#{bin}/acpd --version")
            end
          end
          EOF

          cat acpd.rb

      - name: Update Homebrew tap
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: acp-protocol/homebrew-tap
          event-type: update-formula
          client-payload: '{"formula": "acpd", "version": "${{ steps.version.outputs.version }}"}'
